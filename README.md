# SparkStreaming
Потоковая обработка данных.

№1. 
Задача: пройти все стадии процесса, показанного на уроке, с другими данными.
Для этого взяла небольшой датасет по репетиторам отсюда:
https://www.kaggle.com/c/tutors-expected-math-exam-results
Задание: предсказать средний балл по математике среди учеников разных репетиторов.
TRAIN
https://github.com/olhaexe/SparkStreaming/blob/main/ml_teachers_train.py
Тренировочную часть считала целиком, сразу с приведением данных в числовые форматы.
Построила линейную регрессию со стадиями, как на уроке, за исключением обработки строчного типа данных (их нет в датасете), обучила, сохранила (получается, на уроке модель обучалась на тренировочных данных, сделала так же).

TRANSFORM
https://github.com/olhaexe/SparkStreaming/blob/main/ml_teachers_transform.py
Для имитации поступления информации из Кафки и Кассандры делаю следующее:
- считываю csv-файл с частью информации в стриме,
- создаю топик Кафки и делаю в него sink из этого стрима,
- считываю информацию из Кафки ( csv-файл читается построчно, как и хотелось бы, но, как выяснилось, сразу по схеме не разбирается, помогаю функциями regexp_replace и split,
- подготавливаю DataFrame для запросов к Кассандре с историческими данными - нужны заранее keyspace и таблица того же размера, что и в кафке или файле-источнике. Идея перезатирать таблицу данными, полученными после обработки, мне не нравится, поэтому создаю также таблицу для записи полученных прогнозов.
- считываю файл с баллами и заливаю в подготовленную таблицу Кассандры,
- достаю эти данные из Кассандры и делю по столбцам в нужном порядке — том же, в котором была обучена модель и предполагается запись (Кассандра сортирует столбцы по алфавиту, а строки – в каком-то известном только ей порядке),
логика foreachBatch: 
- на вход датафрейм из Кафки, делаем persist, 
- выбираем из сгруппированных по id строк максимальные возраст, опыт и цену урока, подготавливаем колонки для баллов с нулевыми числовыми(!) значениями,
- готовим строку со списком id,
- делаем запрос к Кассандре по этому списку (быстро, так как это ключи),
- заменяем нулями null-значения, делаем персист, объединяем с данными Кассандры и делаем перегруппировку с выбором максимальных значений,
- получаем предсказание при помощи ранее обученной модели,
- добавляем новые данные во вторую подготовленную таблицу Кассандры,
- делаем анперсист всех данных.


№2. 
Задача: построить другую модель (не регрессию). Взяла градиентный бустинг.
Датасет скачала здесь: https://www.kaggle.com/c/house-prices-advanced-regression-techniques
Задание: предсказать цены, за которые были проданы дома.

TRAIN
https://github.com/olhaexe/SparkStreaming/blob/main/house_prices_train.py
Считываю данные сразу в нужных форматах. Неудобно, так как столбцов много, для каждого нужно прописать тип, но считывание с параметром inferSchema распознает два типа данных –  integer и string, а float делает строкой. Все анализируемые колонки заносим в колонку-вектор features. Пробую сразу скормить неполные столбцы - получается, модель обучается без обработки пропусков благодаря тому, что большинство недостающих данных категориальные и OneHotEncoderEstimator переводит их в дамми-переменные. Если предварительно обрабатывать пропуски средствами pyspark, при прогнозировании вылетают ошибки, поэтому думаю, что исторические данные лучше обрабатывать при помощи pandas либо, если источники распределенные – собирать уже в агрегированном виде. 

TRANSFORM
https://github.com/olhaexe/SparkStreaming/blob/main/house_prices_transform.py
Большой файл не обрабатывает, вылетают ошибки – работает только в нарезке на небольшие. Если в столбце числового типа (LotFrontage) есть null-значение, всю строку заполняет null-значениями, поэтому задаю его в схеме строчным типом, затем меняю с заполнением пропусков. Также присваиваю нулевое значение для id=null: визуально я не вижу их на выводе, но если этого не сделать, при записи в Кассандру будет ошибка. Загружаю модель, выполняю transform на всех данных и записываю id и прогнозируемую цену в Кассандру. В названиях столбцов только маленькие буквы, большие Кассандра не принимает.
